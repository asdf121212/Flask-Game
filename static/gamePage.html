<html>
    <head>
        <title>Mi Big Flask Test</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
        
        <style>
            * { padding: 0; margin: 0; }
            canvas { background: #eee; display: block; margin: 0 auto; }
            body { background: rgb(2,0,36); background: linear-gradient(45deg, rgba(2,0,36,1) 0%, rgba(46,173,75,1) 0%, rgba(179,51,255,1) 100%); }
        </style>

        <script type="text/javascript" charset="utf-8">
            function copyLink() {
                const copyText = document.getElementById('roomLinkP').innerHTML;
                navigator.clipboard.writeText(copyText);
            }
            $(document).ready(function(){
                const parameters = window.location.search;
                const roomId = parameters.substr(1).split('&')[0].split('=')[1];
                document.getElementById("roomCodeP").innerHTML = roomId;
                document.getElementById("roomLinkP").innerHTML = "link copy test";
                const userName = parameters.substr(1).split('&')[1].split('=')[1];
                const playerId = parameters.substr(1).split('&')[2].split('=')[1];//////////////////
                const origin = window.location.origin;
                const canvas = document.getElementById("theCanvas");
                const ctx = canvas.getContext("2d");
                const gradient = ctx.createLinearGradient(0, 0, 1000, 700);
                gradient.addColorStop(0, '#332738');
                gradient.addColorStop(1, '#212621');
                const PLAYER1X0 = 100;
                const PLAYER1Y0 = 300;
                const PLAYER2X0 = 400;
                const PLAYER2Y0 = 100;
                const PLAYER3X0 = 600;
                const PLAYER3Y0 = 300;
                const PLAYER4X0 = 400;
                const PLAYER4Y0 = 300;
                const EGGMAN_SPRITE_BASE_PATH = '/static/sprites/eggMan/';
                const eggManSpriteSheets = {};
                const colors = ['green', 'purple', 'yellow', 'cyan'];
                const modes = ['front', 'back', 'eggFront', 'eggBack'];
                colors.forEach((color) => {
                    eggManSpriteSheets[color] = {};
                    modes.forEach((mode) => {
                        img = new Image();
                        img.src = EGGMAN_SPRITE_BASE_PATH + color + '/' + mode + '.png'
                        eggManSpriteSheets[color][mode] = img;
                    })
                })
                
                const eggManCoords = {
                    restUp : { sx : 0, sy : 0, swidth : 54, sheight : 41 },
                    restDown : { sx : 54, sy : 0, swidth : 54, sheight : 41 },
                    expl1 : { sx : 108, sy : 0, swidth : 54, sheight : 41 },
                    expl2 : { sx : 0, sy : 42, swidth : 54, sheight : 41 },
                    expl3 : { sx : 54, sy : 42, swidth : 54, sheight : 41 },
                    expl4 : { sx : 108, sy : 42, swidth : 54, sheight : 41 },
                    expl5 : { sx : 0, sy : 84, swidth : 54, sheight : 41 },
                    w1 : { sx : 54, sy : 84, swidth : 54, sheight : 41 },
                    w2 : { sx : 108, sy : 84, swidth : 54, sheight : 42 },
                    w3 : { sx : 0, sy : 126, swidth : 54, sheight : 42 },
                    w4 : { sx : 54, sy : 126, swidth : 54, sheight : 42 },
                }

                //1, 2, etc.
                var playerNumber;
                var clientPlayer;
                
                const players = {
                    player1: null,
                    player2: null,
                    player3: null,
                    player4: null
                };

                var leftPressed = false;
                var rightPressed = false;
                var upPressed = false;
                var downPressed = false;

                class Player {
                    constructor(playerName, x, y, numStr) {
                        this.name = playerName;
                        this.x = x;
                        this.y = y;
                        this.dx = 0;
                        this.dy = 0;
                        this.sheets;
                        this.hasEgg = false;
                        this.dying = false;
                        this.animCount = 0;
                        if (numStr == 'player1') {
                            this.sheets = eggManSpriteSheets['green'];
                        } else if (numStr == 'player2') {
                            this.sheets = eggManSpriteSheets['purple'];
                        } else if (numStr == 'player3') {
                            this.sheets = eggManSpriteSheets['yellow'];
                        } else if (numStr == 'player4') {
                            this.sheets = eggManSpriteSheets['cyan'];
                        }
                    }

                    drawSelf() {
                        ctx.fillStyle = "#000000";
                        ctx.fillText(this.name, this.x, this.y - 10);
                        var mode;
                        var sheet;
                        if (this.dy < 0) {
                            sheet = 'back';
                        } else {
                            sheet = 'front';
                        }
                        if (this.dx == 0 && this.dy == 0) {
                            if (this.animCount < 10) {
                                mode = 'restUp';
                            } else if (this.animCount >= 10 && this.animCount < 20) {
                                mode = 'restDown';
                            } else {
                                mode = 'restUp';
                                this.animCount = 0;
                            }
                        } else {
                            if (this.animCount == 0) {
                                mode = 'w1';
                            } else if (this.animCount == 1) {
                                mode = 'w2';
                            } else if (this.animCount == 2) {
                                mode = 'w3';
                            } else {
                                mode = 'w4';
                                this.animCount = 0;
                            }
                        }

                        const sx = eggManCoords[mode].sx;
                        const sy = eggManCoords[mode].sy;
                        const swidth = eggManCoords[mode].swidth;
                        const sheight = eggManCoords[mode].sheight;
                        ctx.drawImage(this.sheets[sheet], sx, sy, swidth, sheight, this.x, this.y, swidth, sheight);
                    }
                }

                const socket = io();

                socket.on('after connect', () => {
                    socket.emit('join event', {
                        'roomId' : roomId,
                        'name' : userName,
                        'playerId' : playerId
                    });
                });
                socket.on('join gamestate', (data) => {
                    playerNumStr = data['playerNumber'];
                    allPlayers = data['gamestate']['players'];
                    for (const playerN in allPlayers) {
                        players[playerN] = new Player(allPlayers[playerN].name, allPlayers[playerN].x, allPlayers[playerN].y, playerN);
                    }
                    clientPlayer = players[playerNumStr]
                });
                // socket.on('player removed', (data) => {
                //     players[data.playerNumber] = null;
                // });
                socket.on('input response', (data) => {
                    clientPlayer.x = data['x'];
                    clientPlayer.y = data['y'];
                });
                socket.on('game update', (data) => {
                    // console.log(JSON.stringify(data))
                    const gameState = data['gameState'];
                    const playersUpdate = gameState['players']
                    for (const player in playersUpdate) {
                        const pl = playersUpdate[player];
                        if (players[player] == null) {
                            players[player] = new Player(pl['name'], pl['x'], pl['y'], player);
                            players[player].dx = pl['dx']
                            players[player].dy = pl['dy']
                        } else {
                            players[player].x = pl['x'];
                            players[player].y = pl['y'];
                            players[player].dx = pl['dx'];
                            players[player].dy = pl['dy'];
                        }
                        if (pl['remove'] == true) {
                            players[player] = null;
                        }
                    }
                });

                document.addEventListener("keydown", keyDownHandler, false);
                document.addEventListener("keyup", keyUpHandler, false);

                function keyDownHandler(e) {
                    if (e.key == "Right" || e.key == "ArrowRight") {
                        rightPressed = true;
                    } else if (e.key == "Left" || e.key == "ArrowLeft") {
                        leftPressed = true;
                    } else if (e.key == "Up" || e.key == "ArrowUp") {
                        upPressed = true;
                    } else if (e.key == "Down" || e.key == "ArrowDown") {
                        downPressed = true;
                    }
                }

                function keyUpHandler(e) {
                    if (e.key == "Right" || e.key == "ArrowRight") {
                        rightPressed = false;
                    } else if (e.key == "Left" || e.key == "ArrowLeft") {
                        leftPressed = false;
                    } else if (e.key == "Up" || e.key == "ArrowUp") {
                        upPressed = false;
                    } else if (e.key == "Down" || e.key == "ArrowDown") {
                        downPressed = false;
                    }
                }

                function update() {
                    if (clientPlayer == null) {
                        return;
                    }
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, 1000, 700);
                    for (const player in players) {
                        currPlayer = players[player];
                        if (currPlayer !== null) {
                            currPlayer.animCount++;
                            currPlayer.drawSelf();
                        }
                    }
                    const input = {
                        'roomId' : roomId,
                        'playerId' : playerId,
                        'rightPressed' : rightPressed,
                        'leftPressed' : leftPressed,
                        'upPressed' : upPressed,
                        'downPressed' : downPressed
                    };
                    socket.emit('playerInput', input)
                }

                setInterval(update, 50);

            
            });
        </script>


    </head>
    <body>
        <canvas id="theCanvas" width="1000" height="700"></canvas>
        <h3>Room Code</h3>
        <p id="roomCodeP">---</p>
        <p id="roomLinkP">---</p>
        <button onclick="copyLink()">Copy link</button>
    </body>
</html>