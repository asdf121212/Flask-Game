<html>
    <head>
        <title>Mi Big Flask Test</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
        
        <style>
            * { padding: 0; margin: 0; }
            canvas { background: #eee; display: block; margin: 0 auto; }
        </style>

        <script type="text/javascript" charset="utf-8">
            $(document).ready(function(){
                const parameters = window.location.search;
                const roomId = parameters.substr(1).split('&')[0].split('=')[1];
                document.getElementById("roomCodeP").innerHTML = roomId
                const userName = parameters.substr(1).split('&')[1].split('=')[1];
                const playerId = parameters.substr(1).split('&')[2].split('=')[1];//////////////////
                const origin = window.location.origin;
                const canvas = document.getElementById("theCanvas");
                const ctx = canvas.getContext("2d");
                const PLAYER1X0 = 100;
                const PLAYER1Y0 = 300;
                const PLAYER2X0 = 400;
                const PLAYER2Y0 = 100;
                const PLAYER3X0 = 600;
                const PLAYER3Y0 = 300;
                const PLAYER4X0 = 400;
                const PLAYER4Y0 = 300;
                const EGGMAN_SPRITE_BASE_PATH = '/static/sprites/eggMan/';
                // var playerId;
                // const greenFrontSheet = new Image();
                // const greenBackSheet = new Image();
                // const greenFrontEggSheet = new Image();
                // const greenBackEggSheet = new Image();
                const eggManSpriteSheets = {};
                const colors = ['green', 'purple', 'yellow', 'cyan'];
                const modes = ['front', 'back', 'eggFront', 'eggBack'];
                colors.forEach((color) => {
                    eggManSpriteSheets[color] = {};
                    modes.forEach((mode) => {
                        img = new Image();
                        img.src = EGGMAN_SPRITE_BASE_PATH + color + '/' + mode + '.png'
                        eggManSpriteSheets[color][mode] = img;
                    })
                })
                // greenFrontSheet.src = '/static/sprites/eggMan/green/greenFront.png';
                // const greenSheets = {
                //     front : new Image(),
                //     back : new Image(),
                //     eggFront : new Image(),
                //     eggBack : new Image()
                // }
                
                const eggManCoords = {
                    restUp : { sx : 0, sy : 0, swidth : 54, sheight : 41 },
                    restDown : { sx : 54, sy : 0, swidth : 54, sheight : 41 },
                    expl1 : { sx : 108, sy : 0, swidth : 54, sheight : 41 },
                    expl2 : { sx : 0, sy : 42, swidth : 54, sheight : 41 },
                    expl3 : { sx : 54, sy : 42, swidth : 54, sheight : 41 },
                    expl4 : { sx : 108, sy : 42, swidth : 54, sheight : 41 },
                    expl5 : { sx : 0, sy : 84, swidth : 54, sheight : 41 },
                    w1 : { sx : 54, sy : 84, swidth : 54, sheight : 41 },
                    w2 : { sx : 108, sy : 84, swidth : 54, sheight : 42 },
                    w3 : { sx : 0, sy : 126, swidth : 54, sheight : 42 },
                    w4 : { sx : 54, sy : 126, swidth : 54, sheight : 42 },
                }

                //1, 2, etc.
                var playerNumber;
                var clientPlayer;
                
                const players = {
                    player1: null,
                    player2: null,
                    player3: null,
                    player4: null
                };

                var leftPressed = false;
                var rightPressed = false;
                var upPressed = false;
                var downPressed = false;

                class Player {
                    constructor(playerName, x, y, numStr) {
                        this.name = playerName;
                        this.x = x;
                        this.y = y;
                        this.dx = 0;
                        this.dy = 0;
                        this.sheets;
                        this.hasEgg = false;
                        this.dying = false;
                        // this.standCount = 0;
                        // this.walkCount = 0;
                        // this.explCount = 0;
                        this.animCount = 0;
                        if (numStr == 'player1') {
                            this.sheets = eggManSpriteSheets['green'];
                        } else if (numStr == 'player2') {
                            this.sheets = eggManSpriteSheets['purple'];
                        } else if (numStr == 'player3') {
                            this.sheets = eggManSpriteSheets['yellow'];
                        } else if (numStr == 'player4') {
                            this.sheets = eggManSpriteSheets['cyan'];
                        }
                    }

                    drawSelf() {
                        // ctx.beginPath();
                        // ctx.arc(this.x, this.y, 10, 0, Math.PI*2);
                        // ctx.fillStyle = "#0095DD";
                        // ctx.fill();
                        // ctx.closePath();
                        // ctx.fillText(this.name, this.x, this.y - 10);
                        var mode;
                        var sheet;
                        if (this.dy < 0) {
                            sheet = 'back';
                        } else {
                            sheet = 'front';
                        }
                        if (this.dx == 0 && this.dy == 0) {
                            if (this.animCount < 10) {
                                mode = 'restUp';
                            } else if (this.animCount >= 10 && this.animCount < 20) {
                                mode = 'restDown';
                            } else {
                                mode = 'restUp';
                                this.animCount = 0;
                            }
                        } else {
                            if (this.animCount == 0) {
                                mode = 'w1';
                            } else if (this.animCount == 1) {
                                mode = 'w2';
                            } else if (this.animCount == 2) {
                                mode = 'w3';
                            } else {
                                mode = 'w4';
                                this.animCount = 0;
                            }
                        }

                        const sx = eggManCoords[mode].sx;
                        const sy = eggManCoords[mode].sy;
                        const swidth = eggManCoords[mode].swidth;
                        const sheight = eggManCoords[mode].sheight;
                        ctx.drawImage(this.sheets[sheet], sx, sy, swidth, sheight, this.x, this.y, swidth, sheight);
                    }
                }

                const socket = io();
                // console.log(socket.toString() + "socket ------")

                socket.on('after connect', () => {
                    // console.log("after connect ----- before emit")
                    socket.emit('join event', {
                        'roomId' : roomId,
                        'name' : userName,
                        'playerId' : playerId
                    });
                    // console.log("after connect ----- after emit")
                });
                socket.on('join gamestate', (data) => {
                    // console.log("join gamestate  -----  " + data)
                    // playerId = data['playerId'];
                    playerNumStr = data['playerNumber'];
                    allPlayers = data['players'];
                    for (const playerN in allPlayers) {
                        players[playerN] = new Player(allPlayers[playerN].name, allPlayers[playerN].x, allPlayers[playerN].y, playerN);
                    }
                    clientPlayer = players[playerNumStr]
                });
                // socket.on('player added', (data) => {
                //     console.log("player added  -----  " + JSON.stringify(data))
                //     if (players[data.playerNumber] === null) {
                //         players[data.playerNumber] = new Player(data.name, data.x, data.y);
                //     }
                // });
                socket.on('player removed', (data) => {
                    // console.log(data + '   player removed')
                    players[data.playerNumber] = null;
                });
                socket.on('input response', (data) => {
                    // console.log("input response  -----  " + JSON.stringify(data))
                    clientPlayer.x = data['x'];
                    clientPlayer.y = data['y'];
                });
                socket.on('game update', (data) => {
                    // console.log("game update  -----  " + JSON.stringify(data))
                    const gameState = data['gameState'];
                    for (const player in gameState) {
                        const pl = gameState[player];
                        if (players[player] == null) {
                            players[player] = new Player(pl['name'], pl['x'], pl['y'], player);
                            players[player].dx = pl['dx']
                            players[player].dy = pl['dy']
                        } else {
                            players[player].x = pl['x'];
                            players[player].y = pl['y'];
                            players[player].dx = pl['dx'];
                            players[player].dy = pl['dy'];
                        }
                    }
                    // const player1data = data['gameState']['player1'];
                    // const player2data = data['gameState']['player2'];
                    // const player3data = data['gameState']['player3'];
                    // const player4data = data['gameState']['player4'];
                    // if (player1data != null) {
                    //     if (players.player1 == null) {
                    //         players.player1 = new Player(player1data['name'], player1data['x'], player1data['y'], 'player1');
                    //     } else {
                    //         players.player1.x = player1data['x'];
                    //         players.player1.y = player1data['y'];
                    //         players.player1.dx = player1data['dx']
                    //     }
                    // }
                    // if (player2data != null) {
                    //     if (players.player2 == null) {
                    //         players.player2 = new Player(player2data['name'], player2data['x'], player2data['y'], 'player2');
                    //     } else {
                    //         players.player2.x = player2data['x'];
                    //         players.player2.y = player2data['y'];
                    //     }
                    // }
                    // if (player3data != null) {
                    //     if (players.player3 == null) {
                    //         players.player3 = new Player(player3data['name'], player3data['x'], player3data['y'], 'player3');
                    //     } else {
                    //         players.player3.x = player3data['x'];
                    //         players.player3.y = player3data['y'];
                    //     }
                    // }
                    // if (player4data != null) {
                    //     if (players.player4 == null) {
                    //         players.player4 = new Player(player4data['name'], player4data['x'], player4data['y'], 'player4');
                    //     } else {
                    //         players.player4.x = player4data['x'];
                    //         players.player4.y = player4data['y'];
                    //     }
                    // }
                    
                });

                document.addEventListener("keydown", keyDownHandler, false);
                document.addEventListener("keyup", keyUpHandler, false);

                function keyDownHandler(e) {
                    if (e.key == "Right" || e.key == "ArrowRight") {
                        rightPressed = true;
                    } else if (e.key == "Left" || e.key == "ArrowLeft") {
                        leftPressed = true;
                    } else if (e.key == "Up" || e.key == "ArrowUp") {
                        upPressed = true;
                    } else if (e.key == "Down" || e.key == "ArrowDown") {
                        downPressed = true;
                    }
                }

                function keyUpHandler(e) {
                    if (e.key == "Right" || e.key == "ArrowRight") {
                        rightPressed = false;
                    } else if (e.key == "Left" || e.key == "ArrowLeft") {
                        leftPressed = false;
                    } else if (e.key == "Up" || e.key == "ArrowUp") {
                        upPressed = false;
                    } else if (e.key == "Down" || e.key == "ArrowDown") {
                        downPressed = false;
                    }
                }

                function update() {
                    // console.log(window.location.pathname);
                    if (clientPlayer == null) {
                        return;
                    }
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    for (const player in players) {
                        currPlayer = players[player];
                        if (currPlayer !== null) {
                            currPlayer.animCount++;
                            currPlayer.drawSelf();
                        }
                    }
                    const input = {
                        'roomId' : roomId,
                        'playerId' : playerId,
                        'rightPressed' : rightPressed,
                        'leftPressed' : leftPressed,
                        'upPressed' : upPressed,
                        'downPressed' : downPressed
                    };
                    socket.emit('playerInput', input)
                    // if (rightPressed) {
                    //     // clientPlayer.x += 1;
                    // } else if (leftPressed) {
                    //     // clientPlayer.x -= 1;
                    // }
                    // if (upPressed) {
                    //     // clientPlayer.y -= 1;
                    // } else if (downPressed) {
                    //     // clientPlayer.y += 1;
                    // }
                }

                setInterval(update, 50);


            });
        </script>


    </head>
    <body>
        <!-- <img src='/static/sprites/eggMan/spriteSheet.png' width="108" height="112"> -->
        <canvas id="theCanvas" width="1000" height="700"></canvas>
        <h3>Room Code</h3>
        <p id="roomCodeP">---</p>
    </body>
</html>